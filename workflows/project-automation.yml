# File: .github/workflows/project-automation.yml
# Place this in your ProgrediSystems/.github repository

name: ProgrediSystems Project Board Automation
on:
  issues:
    types: [opened, labeled, closed, reopened]
  pull_request:
    types: [opened, closed, merged]

jobs:
  auto-assign-to-projects:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'labeled'
    steps:
      - name: Add to Revenue Pipeline (#4)
        if: |
          contains(github.event.issue.labels.*.name, 'revenue-opportunity') ||
          contains(github.event.issue.labels.*.name, 'contract-opportunity') ||
          contains(github.event.issue.labels.*.name, 'client-opportunity') ||
          contains(github.event.issue.title, '$') ||
          contains(github.event.issue.title, 'contract') ||
          contains(github.event.issue.title, 'RFP') ||
          contains(github.event.issue.title, 'revenue')
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/ProgrediSystems/projects/4
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add to Core Development (#5)
        if: |
          contains(github.event.issue.labels.*.name, 'feature') ||
          contains(github.event.issue.labels.*.name, 'enhancement') ||
          contains(github.event.issue.labels.*.name, 'ai-enhancement') ||
          contains(github.event.issue.labels.*.name, 'bug') ||
          contains(github.event.issue.title, 'feature') ||
          contains(github.event.issue.title, 'enhancement') ||
          contains(github.event.issue.title, 'AI') ||
          github.repository == 'ProgrediSystems/progredi-core' ||
          github.repository == 'ProgrediSystems/ai-capabilities'
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/ProgrediSystems/projects/5
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add to Defense Market Focus (#6)
        if: |
          contains(github.event.issue.labels.*.name, 'government-rfp') ||
          contains(github.event.issue.labels.*.name, 'cmmc') ||
          contains(github.event.issue.labels.*.name, 'defense-contract') ||
          contains(github.event.issue.labels.*.name, 'compliance') ||
          contains(github.event.issue.title, 'government') ||
          contains(github.event.issue.title, 'DoD') ||
          contains(github.event.issue.title, 'Army') ||
          contains(github.event.issue.title, 'Navy') ||
          contains(github.event.issue.title, 'CMMC') ||
          github.repository == 'ProgrediSystems/cmmc-compliance' ||
          github.repository == 'ProgrediSystems/progredi-cai-m' ||
          github.repository == 'ProgrediSystems/core-readiness'
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/ProgrediSystems/projects/6
          github-token: ${{ secrets.GITHUB_TOKEN }}

  revenue-impact-calculator:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'revenue-opportunity') ||
      contains(github.event.issue.title, '$') ||
      contains(github.event.issue.title, 'contract') ||
      contains(github.event.issue.title, 'revenue')
    steps:
      - name: Extract Revenue Data
        id: extract
        run: |
          # Extract potential value from issue title and body
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          # Look for dollar amounts (handles $1M, $500K, $2.5M format)
          VALUE=$(echo "$TITLE $BODY" | grep -oE '\$[0-9]+\.?[0-9]*[KMB]?' | head -1 || echo "TBD")
          
          # Determine source repository
          REPO="${{ github.repository }}"
          SOURCE=$(echo $REPO | cut -d'/' -f2)
          
          # Detect contract type
          CONTRACT_TYPE="Commercial"
          if echo "$TITLE $BODY" | grep -iq "government\|dod\|army\|navy\|air force\|marines\|dhs"; then
            CONTRACT_TYPE="Government"
          fi
          
          echo "value=$VALUE" >> $GITHUB_OUTPUT
          echo "source=$SOURCE" >> $GITHUB_OUTPUT
          echo "contract_type=$CONTRACT_TYPE" >> $GITHUB_OUTPUT

      - name: Add Revenue Analysis Comment
        uses: actions/github-script@v7
        with:
          script: |
            const value = "${{ steps.extract.outputs.value }}";
            const source = "${{ steps.extract.outputs.source }}";
            const contractType = "${{ steps.extract.outputs.contract_type }}";
            
            // Determine priority based on value
            let priority = "Medium";
            if (value.includes("M") || (value.includes("K") && parseInt(value.replace(/[^\d]/g, '')) >= 500)) {
              priority = "High";
            }
            if (value.includes("B") || (value.includes("M") && parseInt(value.replace(/[^\d]/g, '')) >= 5)) {
              priority = "Critical";
            }
            
            const comment = `## ðŸ’° Revenue Impact Analysis (AI-Generated)
            
            **Detected Value**: ${value}
            **Contract Type**: ${contractType}
            **Source Repository**: ${source}
            **Recommended Priority**: ${priority}
            
            ### ðŸŽ¯ Automatic Project Assignment:
            âœ… **Revenue Pipeline** (#4) â†’ ðŸ’¡ Opportunities column
            ${contractType === 'Government' ? 'âœ… **Defense Market Focus** (#6) â†’ ðŸ›ï¸ Contract Opportunities' : ''}
            
            ### ðŸ“‹ Next Steps Checklist:
            - [ ] **Validate Revenue Estimate** - Confirm actual contract value
            - [ ] **Set PWin Probability** - Estimate likelihood of winning (10-100%)
            - [ ] **Add Timeline** - Proposal deadline and decision dates
            - [ ] **Assign Team** - Identify proposal team members
            - [ ] **Competitive Analysis** - Research known competitors
            - [ ] **Resource Planning** - Estimate required team and budget
            
            ### ðŸŽ® Project Board Actions:
            1. **Move to ðŸ“‹ Qualifying** when details are confirmed
            2. **Move to ðŸŽ¯ This Quarter** when actively pursuing
            3. **Update custom fields** with contract value and probability
            4. **Move to ðŸ”„ In Progress** when proposal is being written
            
            ### ðŸ”— Quick Links:
            - [Revenue Pipeline Board](https://github.com/orgs/ProgrediSystems/projects/4)
            - [Defense Market Board](https://github.com/orgs/ProgrediSystems/projects/6)
            - [All Revenue Opportunities](https://github.com/orgs/ProgrediSystems/projects/4?filterQuery=label%3Arevenue-opportunity)
            
            ---
            *ðŸ¤– This analysis was auto-generated by ProgrediSystems AI. Update the issue to recalculate.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  ai-powered-labeling:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Auto-Apply Smart Labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const repo = context.repo.repo;
            
            const labelsToAdd = [];
            
            // AI-powered label detection
            
            // Revenue opportunity detection
            if (title.includes('$') || title.includes('contract') || title.includes('rfp') || 
                title.includes('revenue') || title.includes('opportunity')) {
              labelsToAdd.push('revenue-opportunity');
            }
            
            // Government contract detection
            if (title.includes('government') || title.includes('dod') || title.includes('army') || 
                title.includes('navy') || title.includes('air force') || title.includes('federal')) {
              labelsToAdd.push('government-rfp');
            }
            
            // Feature development detection
            if (title.includes('feature') || title.includes('add') || title.includes('new') ||
                title.includes('implement') || title.includes('create')) {
              labelsToAdd.push('feature');
            }
            
            // AI/ML detection
            if (title.includes('ai') || title.includes('ml') || title.includes('machine learning') ||
                title.includes('artificial intelligence') || title.includes('automation')) {
              labelsToAdd.push('ai-enhancement');
            }
            
            // Bug detection
            if (title.includes('bug') || title.includes('fix') || title.includes('error') ||
                title.includes('issue') || title.includes('problem')) {
              labelsToAdd.push('bug');
            }
            
            // CMMC/Compliance detection
            if (title.includes('cmmc') || title.includes('compliance') || title.includes('security') ||
                title.includes('certification') || repo === 'cmmc-compliance') {
              labelsToAdd.push('cmmc');
            }
            
            // Priority detection based on value
            if (title.match(/\$[1-9][0-9]*[Mm]/) || title.includes('critical') || title.includes('urgent')) {
              labelsToAdd.push('priority-high');
            } else if (title.match(/\$[1-9][0-9]*[Bb]/) || title.includes('major')) {
              labelsToAdd.push('priority-critical');
            }
            
            // Repository-specific labels
            if (repo === 'core-contracts') {
              labelsToAdd.push('contract-opportunity');
            } else if (repo === 'client-engagement-system') {
              labelsToAdd.push('client-opportunity');
            } else if (repo === 'progredi-cai-m') {
              labelsToAdd.push('defense-contract');
            }
            
            // Apply detected labels
            if (labelsToAdd.length > 0) {
              console.log(`Auto-applying labels: ${labelsToAdd.join(', ')}`);
              
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labelsToAdd
                });
                
                // Add a comment explaining the auto-labeling
                const labelComment = `## ðŸ·ï¸ AI Auto-Labeling Applied
                
                The following labels were automatically applied based on issue analysis:
                ${labelsToAdd.map(label => `- \`${label}\``).join('\n')}
                
                **Reasoning**: Content analysis detected keywords related to these categories.
                
                Feel free to add or remove labels as needed. The project boards will update automatically.
                
                ---
                *ðŸ¤– Auto-generated by ProgrediSystems AI labeling system*`;
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: labelComment
                });
                
              } catch (error) {
                console.error('Error applying labels:', error);
              }
            }

  weekly-project-health:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Generate Weekly Project Health Report
        uses: actions/github-script@v7
        with:
          script: |
            // Weekly project health monitoring
            console.log("Generating weekly project health report...");
            
            // This would analyze project board health, velocity, etc.
            // Implementation can be expanded based on needs
